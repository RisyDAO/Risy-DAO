<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risy DAO Governor</title>
    <meta name="description" content="Risy DAO Governor - Decentralized Governance for RISY Token on Polygon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.1.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #6366F1, #3B82F6, #2DD4BF);
        }

        .text-gradient {
            background: linear-gradient(135deg, #6366F1, #3B82F6, #2DD4BF);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white" x-data="daoApp()" x-init="init">
    <header class="fixed w-full z-10 bg-gray-900 bg-opacity-90 backdrop-blur-md">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <a href="#" class="text-2xl font-bold text-gradient">Risy DAO Governor</a>
                <div class="flex space-x-4 items-center">
                    <span x-show="networkName !== 'matic'" class="text-red-500 mr-2">
                        <i class="fas fa-exclamation-triangle"></i> Wrong Network
                    </span>
                    <button x-show="!address" @click="connect" class="bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-700 transition">
                        Connect Wallet
                    </button>
                    <span x-show="address" class="bg-indigo-600 text-white px-4 py-2 rounded-full">
                        <span x-text="shortAddress"></span>
                        <i class="fas fa-circle text-green-500 ml-2"></i>
                    </span>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 pt-24 pb-12">
        <section x-show="!address" class="text-center py-20">
            <h2 class="text-4xl font-bold mb-4 animate-float">Welcome to Risy DAO Governor</h2>
            <p class="mb-8">Connect your wallet to participate in governance</p>
            <button @click="connect" class="bg-indigo-600 text-white px-6 py-3 rounded-full hover:bg-indigo-700 transition text-lg">
                Connect Wallet
            </button>
        </section>

        <div x-show="address">
            <section id="overview" class="mb-12">
                <h2 class="text-3xl font-bold mb-4">DAO Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-2">Voting Power</h3>
                        <p class="text-2xl" x-text="votingPower"></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-2">Proposals</h3>
                        <p class="text-2xl" x-text="proposalCount"></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-2">Quorum</h3>
                        <p class="text-2xl" x-text="quorum"></p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-2">Token Balance</h3>
                        <p class="text-2xl" x-text="tokenBalance"></p>
                    </div>
                </div>
            </section>

            <section id="delegation" class="mb-12">
                <h2 class="text-3xl font-bold mb-4">Delegate Voting Power</h2>
                <form @submit.prevent="delegate" class="flex space-x-4">
                    <input type="text" x-model="delegateAddress" placeholder="Address to delegate to" class="flex-grow bg-gray-700 rounded px-4 py-2">
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 transition">
                        Delegate
                    </button>
                </form>
            </section>

            <section id="proposals" class="mb-12">
                <h2 class="text-3xl font-bold mb-4">Proposals</h2>
                <div class="mb-4">
                    <select x-model="proposalFilter" class="bg-gray-700 rounded px-4 py-2">
                        <option value="active">Active Proposals</option>
                        <option value="all">All Proposals</option>
                    </select>
                </div>
                <div class="space-y-6" x-show="!isLoading">
                    <template x-for="proposal in paginatedProposals" :key="proposal.id">
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <h3 class="text-xl font-semibold mb-2" x-text="proposal.title"></h3>
                            <p class="mb-4" x-text="proposal.description"></p>
                            <div class="flex justify-between items-center mb-4">
                                <span>
                                    <i class="fas fa-clock"></i>
                                    Ends: <span x-text="formatDate(proposal.deadline)"></span>
                                </span>
                                <span>
                                    ID: <span x-text="proposal.id"></span>
                                </span>
                            </div>
                            <div class="flex space-x-4" x-show="proposal.state === 'Active'">
                                <button @click="vote(proposal.id, 1)" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition flex-1">
                                    <i class="fas fa-check mr-2"></i> For
                                </button>
                                <button @click="vote(proposal.id, 0)" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition flex-1">
                                    <i class="fas fa-times mr-2"></i> Against
                                </button>
                                <button @click="vote(proposal.id, 2)" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 transition flex-1">
                                    <i class="fas fa-minus mr-2"></i> Abstain
                                </button>
                            </div>
                            <div x-show="proposal.state !== 'Active'" class="text-center py-2 bg-gray-700 rounded">
                                <span x-text="proposal.state"></span>
                            </div>
                        </div>
                    </template>
                </div>
                <div x-show="isLoading" class="text-center py-10">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p class="mt-4">Loading proposals...</p>
                </div>
                <div x-show="!isLoading && filteredProposals.length === 0" class="text-center py-10">
                    <p>No proposals available.</p>
                </div>
                <div class="mt-6 flex justify-center space-x-4" x-show="filteredProposals.length > itemsPerPage">
                    <button @click="prevPage" :disabled="currentPage === 1" class="px-4 py-2 bg-gray-700 rounded" :class="{ 'opacity-50 cursor-not-allowed': currentPage === 1 }">
                        Previous
                    </button>
                    <span class="px-4 py-2">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></span>
                    <button @click="nextPage" :disabled="currentPage === totalPages" class="px-4 py-2 bg-gray-700 rounded" :class="{ 'opacity-50 cursor-not-allowed': currentPage === totalPages }">
                        Next
                    </button>
                </div>
            </section>

            <section id="create-proposal" class="mb-12">
                <h2 class="text-3xl font-bold mb-4">Create Proposal</h2>
                <form @submit.prevent="createProposal" class="space-y-4">
                    <div>
                        <label for="title" class="block mb-2">Title</label>
                        <input type="text" id="title" x-model="newProposal.title" required class="w-full bg-gray-700 rounded px-4 py-2">
                    </div>
                    <div>
                        <label for="description" class="block mb-2">Description</label>
                        <textarea id="description" x-model="newProposal.description" required class="w-full bg-gray-700 rounded px-4 py-2 h-32"></textarea>
                    </div>
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-full hover:bg-indigo-700 transition">
                        Submit Proposal
                    </button>
                </form>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 py-6">
        <div class="container mx-auto px-6 text-center">
            <p>© 2024 Risy DAO. All rights reserved.</p>
        </div>
    </footer>

    <script>
        function daoApp() {
            return {
                address: '',
                shortAddress: '',
                votingPower: '0',
                proposalCount: '0',
                quorum: '0',
                tokenBalance: '0',
                proposals: [],
                newProposal: {
                    title: '',
                    description: ''
                },
                delegateAddress: '',
                provider: null,
                signer: null,
                governorContract: null,
                tokenContract: null,
                networkName: '',
                isLoading: true,
                currentPage: 1,
                itemsPerPage: 5,
                proposalFilter: 'active',

                async init() {
                    this.initializeContracts();
                    this.setupEventListeners();
                    await this.checkNetwork();
                    await this.tryAutoConnect();
                    this.animateTitle();
                    this.startPolling();
                },

                initializeContracts() {
                    this.provider = new ethers.providers.Web3Provider(window.ethereum);
                    this.governorContract = new ethers.Contract(
                        '0xD74E510a6472B20910ABCF8a3945E445b16aE11A',
                        [
                            'function getVotes(address account, uint256 blockNumber) view returns (uint256)',
                            'function proposalCount() view returns (uint256)',
                            'function quorum(uint256 blockNumber) view returns (uint256)',
                            'function propose(address[] targets, uint256[] values, bytes[] calldatas, string description) returns (uint256)',
                            'function castVote(uint256 proposalId, uint8 support) returns (uint256)',
                            'function state(uint256 proposalId) view returns (uint8)',
                            'function proposalSnapshot(uint256 proposalId) view returns (uint256)',
                            'function proposalDeadline(uint256 proposalId) view returns (uint256)',
                            'function getProposalDescription(uint256 proposalId) view returns (string)'
                        ],
                        this.provider
                    );
                    this.tokenContract = new ethers.Contract(
                        '0xca154cF88F6ffBC23E16B5D08a9Bf4851FB97199',
                        [
                            'function balanceOf(address account) view returns (uint256)',
                            'function decimals() view returns (uint8)',
                            'function delegate(address delegatee) returns ()',
                            'function delegates(address account) view returns (address)'
                        ],
                        this.provider
                    );
                },

                setupEventListeners() {
                    if (typeof window.ethereum !== 'undefined') {
                        window.ethereum.on('accountsChanged', this.handleAccountsChanged.bind(this));
                        window.ethereum.on('chainChanged', this.handleChainChanged.bind(this));
                    }
                },

                async tryAutoConnect() {
                    const accounts = await this.provider.listAccounts();
                    if (accounts.length > 0) {
                        await this.connect();
                    }
                },

                animateTitle() {
                    anime({
                        targets: '.animate-float',
                        translateY: [-20, 0],
                        opacity: [0, 1],
                        easing: 'easeOutQuad',
                        duration: 800,
                        delay: anime.stagger(100)
                    });
                },

                async checkNetwork() {
                    const network = await this.provider.getNetwork();
                    this.networkName = network.name;
                    if (network.chainId !== 137) {
                        this.showAlert('Wrong Network', 'Please connect to Polygon Mainnet', 'warning');
                    }
                },

                handleAccountsChanged(accounts) {
                    if (accounts.length === 0) {
                        this.disconnect();
                    } else if (accounts[0] !== this.address) {
                        this.connect();
                    }
                },

                handleChainChanged() {
                    window.location.reload();
                },

                async connect() {
                    try {
                        await this.provider.send("eth_requestAccounts", []);
                        this.signer = this.provider.getSigner();
                        this.address = await this.signer.getAddress();
                        this.shortAddress = `${this.address.slice(0, 6)}...${this.address.slice(-4)}`;
                        await this.updateStats();
                        await this.fetchProposals();
                        this.showToast('Connected!', 'Your wallet has been successfully connected.', 'success');
                    } catch (error) {
                        console.error('Connection error:', error);
                        this.showAlert('Connection Failed', 'Failed to connect wallet. Please try again.', 'error');
                    }
                },

                disconnect() {
                    this.resetState();
                    this.showToast('Disconnected', 'Your wallet has been disconnected.', 'info');
                },

                resetState() {
                    this.address = '';
                    this.shortAddress = '';
                    this.votingPower = '0';
                    this.proposalCount = '0';
                    this.quorum = '0';
                    this.tokenBalance = '0';
                    this.proposals = [];
                },

                startPolling() {
                    setInterval(async () => {
                        if (this.address) {
                            await this.updateStats();
                            await this.fetchProposals();
                        }
                    }, 30000); // Poll every 30 seconds
                },

                async updateStats() {
                    try {
                        const [votes, proposalCount, quorum, balance] = await Promise.all([
                            this.getVotingPower(),
                            this.getProposalCount(),
                            this.getQuorum(),
                            this.getTokenBalance()
                        ]);
                        
                        this.votingPower = votes;
                        this.proposalCount = proposalCount;
                        this.quorum = quorum;
                        this.tokenBalance = balance;

                        this.animateStats();
                    } catch (error) {
                        console.error('Error updating stats:', error);
                        this.showAlert('Error', 'Failed to update stats. Please try again later.', 'error');
                    }
                },

                async getVotingPower() {
                    const latestBlock = await this.provider.getBlockNumber();
                    const votes = await this.governorContract.getVotes(this.address, latestBlock - 1);
                    const decimals = await this.tokenContract.decimals();
                    return ethers.utils.formatUnits(votes, decimals);
                },

                async getProposalCount() {
                    return (await this.governorContract.proposalCount()).toString();
                },

                async getQuorum() {
                    const latestBlock = await this.provider.getBlockNumber();
                    const quorumBN = await this.governorContract.quorum(latestBlock - 1);
                    const decimals = await this.tokenContract.decimals();
                    return ethers.utils.formatUnits(quorumBN, decimals);
                },

                async getTokenBalance() {
                    const balance = await this.tokenContract.balanceOf(this.address);
                    const decimals = await this.tokenContract.decimals();
                    return ethers.utils.formatUnits(balance, decimals);
                },

                animateStats() {
                    anime({
                        targets: '#overview .text-2xl',
                        innerHTML: (el) => [0, el.innerHTML],
                        round: 1,
                        easing: 'easeInOutExpo'
                    });
                },

                async fetchProposals() {
                    this.isLoading = true;
                    this.proposals = [];
                    try {
                        const count = await this.governorContract.proposalCount();
                        const proposalPromises = [];
                        for (let i = count; i > 0; i--) {
                            proposalPromises.push(this.fetchProposal(i));
                        }
                        this.proposals = await Promise.all(proposalPromises);
                        this.proposals = this.proposals.filter(p => p !== null);
                    } catch (error) {
                        console.error('Error fetching proposals:', error);
                        this.showAlert('Error', 'Failed to fetch proposals. Please try again later.', 'error');
                    }
                    this.isLoading = false;
                },

                async fetchProposal(id) {
                    try {
                        const [state, description, snapshot, deadline] = await Promise.all([
                            this.governorContract.state(id),
                            this.governorContract.getProposalDescription(id),
                            this.governorContract.proposalSnapshot(id),
                            this.governorContract.proposalDeadline(id)
                        ]);
                        
                        return {
                            id: id,
                            title: description.split('\n')[0],
                            description: description.split('\n').slice(1).join('\n'),
                            snapshot: snapshot.toString(),
                            deadline: deadline.toString(),
                            state: this.getProposalState(state)
                        };
                    } catch (error) {
                        console.error(`Error fetching proposal ${id}:`, error);
                        return null;
                    }
                },

                getProposalState(state) {
                    const states = ['Pending', 'Active', 'Canceled', 'Defeated', 'Succeeded', 'Queued', 'Expired', 'Executed'];
                    return states[state];
                },

                async createProposal() {
                    if (!this.ensureWalletConnected()) return;

                    try {
                        const tx = await this.executeTransaction(
                            this.governorContract.propose,
                            [[], [], [], `${this.newProposal.title}\n\n${this.newProposal.description}`],
                            'Your proposal is being created. Please wait for confirmation.'
                        );
                        
                        await this.handleTransactionResult(tx, 'Proposal Created', 'Your proposal has been successfully created!');
                        this.resetProposalForm();
                        await this.updateStats();
                        await this.fetchProposals();
                    } catch (error) {
                        this.handleTransactionError(error, 'Failed to create proposal. Please try again.');
                    }
                },

                async vote(proposalId, support) {
                    if (!this.ensureWalletConnected()) return;

                    try {
                        const tx = await this.executeTransaction(
                            this.governorContract.castVote,
                            [proposalId, support],
                            'Your vote is being cast. Please wait for confirmation.'
                        );
                        
                        await this.handleTransactionResult(tx, 'Vote Cast', 'Your vote has been successfully cast!');
                        await this.updateStats();
                        await this.fetchProposals();
                    } catch (error) {
                        this.handleTransactionError(error, 'Failed to cast vote. Please try again.');
                    }
                },

                async delegate() {
                    if (!this.ensureWalletConnected()) return;

                    if (!this.isValidAddress(this.delegateAddress)) {
                        this.showAlert('Invalid Address', 'Please enter a valid Ethereum address', 'error');
                        return;
                    }

                    try {
                        const tx = await this.executeTransaction(
                            this.tokenContract.delegate,
                            [this.delegateAddress],
                            'Your delegation request is being processed. Please wait for confirmation.'
                        );
                        
                        await this.handleTransactionResult(tx, 'Delegation Successful', 'Your voting power has been successfully delegated!');
                        this.delegateAddress = '';
                        await this.updateStats();
                    } catch (error) {
                        this.handleTransactionError(error, 'Failed to delegate. Please try again.');
                    }
                },

                async executeTransaction(method, args, pendingMessage) {
                    const tx = await method.apply(this.signer ? method.connect(this.signer) : method, args);
                    this.showTransactionPending(pendingMessage);
                    return tx;
                },

                async handleTransactionResult(tx, successTitle, successMessage) {
                    await tx.wait();
                    this.showAlert(successTitle, successMessage, 'success');
                },

                handleTransactionError(error, errorMessage) {
                    console.error('Transaction error:', error);
                    this.showAlert('Error', errorMessage, 'error');
                },

                ensureWalletConnected() {
                    if (!this.signer) {
                        this.showAlert('Wallet Not Connected', 'Please connect your wallet first', 'warning');
                        return false;
                    }
                    return true;
                },

                isValidAddress(address) {
                    return ethers.utils.isAddress(address);
                },

                resetProposalForm() {
                    this.newProposal.title = '';
                    this.newProposal.description = '';
                },

                showAlert(title, text, icon) {
                    return Swal.fire({title, text, icon});
                },

                showToast(title, text, icon) {
                    return Swal.fire({
                        title, text, icon,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                },

                showTransactionPending(text) {
                    return Swal.fire({
                        title: 'Transaction Submitted',
                        text,
                        icon: 'info',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                },

                formatDate(timestamp) {
                    return new Date(timestamp * 1000).toLocaleString();
                },

                get filteredProposals() {
                    return this.proposalFilter === 'active'
                        ? this.proposals.filter(p => p.state === 'Active')
                        : this.proposals;
                },

                get paginatedProposals() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredProposals.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredProposals.length / this.itemsPerPage);
                },

                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },

                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                }
            };
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('daoApp', daoApp);
        });
    </script>
</body>
</html>